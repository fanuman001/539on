<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Julia æ’ç­ç³»çµ± - ELITE v5.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;700;900&display=swap');

        :root { 
            --blue: #00d2ff; --red: #ff4757; --green: #2ed573; --gold: #fbc531; 
            --bg: #05070a; --card: #12141c; --border: #1e222e; --gray: #7f8c8d;
        }
        
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg); color: #e1e1e1; margin: 0; padding: 15px;
        }

        .card { background: var(--card); padding: 18px; border-radius: 20px; margin-bottom: 12px; border: 1px solid var(--border); }
        h2 { color: var(--gold); text-align: center; font-size: 20px; margin-bottom: 20px; }
        
        /* çµ±è¨ˆå€ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .stat-box { background: #000; padding: 12px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .stat-val { display: block; font-size: 18px; font-weight: 900; color: var(--blue); font-family: 'JetBrains Mono'; }
        .stat-label { font-size: 10px; color: var(--gray); }
        .warn { border: 1px solid var(--red); box-shadow: 0 0 10px rgba(255, 71, 87, 0.2); }

        /* è¡¨æ ¼å€ */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { color: var(--gray); padding: 10px; border-bottom: 2px solid var(--border); }
        td { padding: 12px 5px; border-bottom: 1px solid var(--border); text-align: center; }
        .original { text-decoration: line-through; color: #555; font-size: 11px; }
        .current { color: var(--blue); font-weight: bold; display: block; }

        /* æ§åˆ¶å€ */
        select, input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); color: #fff; border-radius: 10px; margin-bottom: 10px; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; margin-top: 5px; }
        .btn-swap { background: var(--blue); color: #000; }
        .btn-adj { background: var(--green); color: #000; }
        
        .loading { text-align: center; padding: 40px; color: var(--gray); font-style: italic; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ§§ JULIA æ’ç­ç®¡ç†ç³»çµ±</h2>
        
        <div id="statsArea" class="stats-grid">
            <div class="stat-box"><span class="stat-label">ORA</span><span id="hrs-Ora" class="stat-val">0.0</span></div>
            <div class="stat-box"><span class="stat-label">EVA</span><span id="hrs-Eva" class="stat-val">0.0</span></div>
            <div class="stat-box"><span class="stat-label">JAMES</span><span id="hrs-James" class="stat-val">0.0</span></div>
        </div>
    </div>

    <div class="card" style="padding: 10px;">
        <div id="scheduleArea" class="loading">ç³»çµ±é€£ç·šä¸­...</div>
    </div>

    <div class="card">
        <b style="font-size: 13px; color: var(--gray);">âš™ï¸ è‡¨æ™‚èª¿æ•´å·¥å…·</b>
        <div style="margin-top: 15px;">
            <input type="date" id="opDate" value="2026-02-14">
            <select id="targetName">
                <option value="Ora">Ora (B)</option>
                <option value="Eva">Eva (C)</option>
                <option value="James">James (D)</option>
            </select>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-swap" onclick="handleSwap()">æ›´æ›ç­æ¬¡</button>
                <button class="btn btn-adj" onclick="handleAdjust()">ä¿®æ­£å·¥æ™‚</button>
            </div>
            <input type="number" id="adjHours" placeholder="å¢æ¸›æ™‚æ•¸ (å¦‚ 1.5 æˆ– -1)" style="margin-top: 10px;">
        </div>
    </div>

    <script>
        // å¾ä½ çš„ä»£ç¢¼ä¸­æŠ“å–çš„é‘°åŒ™
        const SUPABASE_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function init() {
            await loadStats();
            await loadSchedule();
        }

        // è¼‰å…¥ç´¯è¨ˆå·¥æ™‚èˆ‡å…¬å¹³æ€§é‚è¼¯
        async function loadStats() {
            try {
                const { data } = await supabaseClient.from('work_logs').select('name, duration');
                const sum = { Ora: 0, Eva: 0, James: 0 };
                data?.forEach(d => { if(sum[d.name] !== undefined) sum[d.name] += d.duration; });

                const sorted = Object.entries(sum).sort((a,b) => b[1] - a[1]);
                const maxVal = sorted[0][1];

                for (let name in sum) {
                    const el = document.getElementById(`hrs-${name}`);
                    const box = el.parentElement;
                    el.innerText = sum[name].toFixed(1);
                    
                    // å…¬å¹³æ€§æª¢æŸ¥ï¼šå·¥æ™‚æœ€é«˜çš„äººæ¨™ç´…æ¡†
                    box.classList.toggle('warn', sum[name] === maxVal && maxVal > 0);
                }
            } catch (e) { console.error(e); }
        }

        // è¼‰å…¥å¯¦æ™‚ç­è¡¨
        async function loadSchedule() {
            const area = document.getElementById('scheduleArea');
            try {
                const { data: base, error: e1 } = await supabaseClient.from('base_schedule').select('*').order('work_date');
                const { data: swaps, error: e2 } = await supabaseClient.from('swap_logs').select('*');

                if (e1) throw e1;

                let html = '<table><tr><th>æ—¥æœŸ</th><th>æ—©ç­</th><th>æ™šç­</th></tr>';
                base.forEach(b => {
                    const daySwaps = swaps ? swaps.filter(s => s.work_date === b.work_date) : [];
                    
                    // æ—©ç­æ¸²æŸ“
                    let mName = b.morning_shift;
                    let mSwap = daySwaps.find(s => s.original_owner === mName);
                    let mFinal = mSwap ? `<span class="original">${mName}</span><span class="current">${mSwap.new_name}</span>` : mName;

                    // æ™šç­æ¸²æŸ“
                    let eFinal = b.evening_shift.map(p => {
                        let eSwap = daySwaps.find(s => s.original_owner === p);
                        return eSwap ? `<span class="original">${p}</span><span class="current">${eSwap.new_name}</span>` : p;
                    }).join('<div style="height:5px"></div>');

                    html += `<tr>
                        <td style="color:var(--gray)">${b.work_date.slice(5)}</td>
                        <td><small style="color:var(--red)">J+</small>${mFinal}</td>
                        <td>${eFinal}</td>
                    </tr>`;
                });
                html += '</table>';
                area.innerHTML = html;
            } catch (e) {
                area.innerHTML = `<div style="color:var(--red); font-size:12px;">é€£ç·šå¤±æ•—: ${e.message}</div>`;
            }
        }

        // è™•ç†æ›ç­ (åŸæ’ç­ä¸åˆªæ¸›ï¼Œä»¥è¦†è“‹é¡¯ç¤º)
        async function handleSwap() {
            const date = document.getElementById('opDate').value;
            const original = prompt("èª°è¦è¢«æ›æ‰? (Ora/Eva/James)");
            const newName = document.getElementById('targetName').value;
            if(!original || !newName) return;

            await supabaseClient.from('swap_logs').insert([{ 
                work_date: date, 
                original_owner: original, 
                new_name: newName 
            }]);
            alert("ç­æ¬¡æ›´æ›æˆåŠŸ");
            init();
        }

        // è™•ç†å·¥æ™‚ä¿®æ­£
        async function handleAdjust() {
            const name = document.getElementById('targetName').value;
            const hrs = parseFloat(document.getElementById('adjHours').value);
            if(isNaN(hrs)) return alert("è«‹è¼¸å…¥æ•¸å­—");

            await supabaseClient.from('work_logs').insert([{ 
                name: name, 
                duration: hrs, 
                note: 'æ‰‹å‹•ä¿®æ­£' 
            }]);
            alert("å·¥æ™‚å·²æ›´æ–°");
            document.getElementById('adjHours').value = '';
            init();
        }

        init();
    </script>
</body>
</html>
