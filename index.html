<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julia å½©åˆ¸è¡Œå¯¦æ™‚æ’ç­ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #d32f2f; --swapped: #0288d1; }
        body { font-family: sans-serif; background: #f0f2f5; padding: 10px; max-width: 800px; margin: auto; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
        .original-name { text-decoration: line-through; color: #999; font-size: 0.8em; }
        .new-name { color: var(--swapped); font-weight: bold; display: block; }
        .boss { color: var(--primary); font-weight: bold; }
        .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-swap { background: var(--swapped); color: white; width: 100%; }
        .stats-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
        .alert { background: #fff3e0; border-left: 4px solid #ff9800; padding: 10px; font-size: 0.9em; }
    </style>
</head>
<body>

    <h2>ğŸ§§ Julia å½©åˆ¸è¡Œå‹•æ…‹ç­è¡¨</h2>

    <div class="card">
        <h3>âš–ï¸ ç´¯è¨ˆå·¥æ™‚ (å¤šè€…æ‡‰ä¼‘æ¯)</h3>
        <div id="statsArea">è¼‰å…¥è³‡æ–™ä¸­...</div>
    </div>

    <div class="card">
        <h3>ğŸ“… 2/14 - 2/22 å¯¦æ™‚ç­è¡¨</h3>
        <div id="scheduleContainer">è¼‰å…¥ç­è¡¨ä¸­...</div>
    </div>

    <div class="card">
        <h3>ğŸ”„ è‡¨æ™‚æ›´æ›ç­æ¬¡ (é»å°é»äº¤æ›)</h3>
        <input type="date" id="swapDate" value="2026-02-14">
        <select id="whoOff"><option value="">-- èª°è¦è«‹å‡/æ›èµ° --</option><option value="Ora">Ora</option><option value="Eva">Eva</option><option value="James">James</option></select>
        <select id="whoOn"><option value="">-- èª°ä¾†ä»£ç­/æ›å…¥ --</option><option value="Ora">Ora</option><option value="Eva">Eva</option><option value="James">James</option></select>
        <button class="btn btn-swap" onclick="handleSwap()">ç¢ºèªæ›´æ›</button>
    </div>

    <script>
        const SUPABASE_URL = 'ä½ çš„_URL';
        const SUPABASE_KEY = 'ä½ çš„_KEY';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function init() {
            await loadSchedule();
            await loadStats();
        }

        async function loadSchedule() {
            // æŠ“å–åŸºç¤ç­è¡¨èˆ‡æ›ç­ç´€éŒ„
            const { data: base } = await supabase.from('base_schedule').select('*').order('work_date');
            const { data: swaps } = await supabase.from('swap_logs').select('*');

            let html = '<table><tr><th>æ—¥æœŸ</th><th>æ—©ç­ (08-15)</th><th>æ™šç­ (15-22)</th></tr>';
            
            base.forEach(item => {
                const dateStr = item.work_date;
                const daySwaps = swaps.filter(s => s.work_date === dateStr);
                
                // è™•ç†æ—©ç­é¡¯ç¤º
                let morningDisplay = `<span class="boss">Julia</span> + ${item.morning_shift}`;
                daySwaps.forEach(s => {
                    if (s.original_owner === item.morning_shift) {
                        morningDisplay = `<span class="boss">Julia</span> + <span class="original-name">${s.original_owner}</span><span class="new-name">${s.new_name}</span>`;
                    }
                });

                // è™•ç†æ™šç­é¡¯ç¤º
                let eveningDisplay = item.evening_shift.map(p => {
                    const s = daySwaps.find(sw => sw.original_owner === p);
                    return s ? `<span class="original-name">${p}</span><span class="new-name">${s.new_name}</span>` : p;
                }).join('<br>');

                html += `<tr><td>${dateStr.slice(5)}</td><td>${morningDisplay}</td><td>${eveningDisplay}</td></tr>`;
            });
            html += '</table>';
            document.getElementById('scheduleContainer').innerHTML = html;
        }

        async function handleSwap() {
            const date = document.getElementById('swapDate').value;
            const off = document.getElementById('whoOff').value;
            const on = document.getElementById('whoOn').value;
            if (!off || !on) return alert("è«‹é¸å–äººå“¡");

            const { error } = await supabase.from('swap_logs').insert([{ 
                work_date: date, original_owner: off, new_name: on 
            }]);

            if (!error) {
                alert("æ›ç­æˆåŠŸï¼");
                init();
            }
        }

        async function loadStats() {
            const { data } = await supabase.from('work_logs').select('name, duration');
            const summary = { Ora: 0, Eva: 0, James: 0 };
            data?.forEach(d => summary[d.name] += d.duration);

            const sorted = Object.entries(summary).sort((a,b) => b[1] - a[1]);
            const maxVal = sorted[0][1];

            let html = "";
            for (let [name, hours] of Object.entries(summary)) {
                let alertMsg = (hours === maxVal && hours > 0) ? ' âš ï¸ ä¼‘æ¯é å®š' : '';
                html += `<div class="stats-item"><span>${name}</span> <span>${hours.toFixed(1)} hrs <b>${alertMsg}</b></span></div>`;
            }
            document.getElementById('statsArea').innerHTML = html;
        }

        init();
    </script>
</body>
</html>

