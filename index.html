<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½©åˆ¸è¡Œå…¬å¹³æ’ç­ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #d32f2f; --secondary: #0288d1; --warn: #f57c00; }
        body { font-family: sans-serif; background: #f4f7f6; padding: 15px; max-width: 800px; margin: auto; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; }
        th { background: #f8f9fa; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-clockin { background: var(--primary); color: white; }
        .btn-clockout { background: var(--secondary); color: white; }
        .high-workload { background: #ffebee; border: 1px solid var(--primary); color: var(--primary); padding: 5px; border-radius: 4px; font-weight: bold; }
        .user-status { font-size: 1.2em; text-align: center; margin: 10px 0; color: #333; }
        .flex-row { display: flex; align-items: center; justify-content: space-between; }
    </style>
</head>
<body>

    <h2>ğŸ§§ Julia å½©åˆ¸è¡Œå…¬å¹³å·¥æ™‚ç³»çµ±</h2>

    <div class="card">
        <select id="userSelect" style="width:100%; padding:10px;">
            <option value="">-- è«‹é¸æ“‡æ‚¨çš„èº«åˆ† --</option>
            <option value="Ora">Ora (B)</option>
            <option value="Eva">Eva (C)</option>
            <option value="James">James (D)</option>
        </select>
        <div id="currentUserDisplay" class="user-status">è«‹å…ˆç™»å…¥</div>
        <div class="btn-group">
            <button class="btn-clockin" onclick="handleClockIn()">é–‹å§‹ä¸Šç­</button>
            <button class="btn-clockout" onclick="handleClockOut()">çµæŸä¸‹ç­</button>
        </div>
        <p id="shiftStatus" style="text-align:center; font-size:0.9em;"></p>
    </div>

    <div class="card">
        <h3>âš–ï¸ å·¥æ™‚ç´¯è¨ˆèˆ‡å…¬å¹³æ€§å»ºè­°</h3>
        <div id="statsArea">è¼‰å…¥ä¸­...</div>
        <p style="font-size:0.8em; color: #666;">* ç³»çµ±æœƒæ ¹æ“šç´¯è¨ˆæ™‚æ•¸ï¼Œå»ºè­°èª°æ‡‰è©²å„ªå…ˆä¼‘æ¯ã€‚</p>
    </div>

    <div class="card">
        <h3>ğŸ“… 2/14-2/22 åŸè¨‚æ’ç­ (åƒè€ƒ)</h3>
        <div id="baseSchedule" style="max-height: 200px; overflow-y: auto;"></div>
    </div>

    <div class="card">
        <h3>ğŸ”„ è‡¨æ™‚è«‹å‡/ä»£ç­ç™»è¨˜</h3>
        <label>åŸè¨‚æ˜¯èª°çš„ç­ï¼Ÿ</label>
        <select id="originalOwner"><option value="Ora">Ora</option><option value="Eva">Eva</option><option value="James">James</option></select>
        <label>ä»£ç­æ™‚æ•¸</label>
        <input type="number" id="manualHours" placeholder="å°æ™‚ (ä¾‹å¦‚ 1.5)" style="width:95%; padding:10px; margin:5px 0;">
        <button onclick="handleManualLog()" style="width:100%; background:#4caf50; color:white;">æäº¤ä»£ç­æ™‚æ•¸</button>
    </div>

    <script>
        const SUPABASE_URL = 'ä½ çš„_URL';
        const SUPABASE_KEY = 'ä½ çš„_KEY';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const members = ['Ora', 'Eva', 'James'];
        let startTime = null;

        // ç”Ÿæˆé æ’ç­è¡¨ (B:Ora, C:Eva, D:James)
        function renderBaseSchedule() {
            let html = '<table><tr><th>æ—¥æœŸ</th><th>æ—©ç­</th><th>æ™šç­</th></tr>';
            for (let i = 0; i < 9; i++) {
                let mIdx = i % 3;
                let morning = members[mIdx];
                let evening = members.filter(m => m !== morning).join('+');
                html += `<tr><td>2/${14+i}</td><td>A+${morning}</td><td>${evening}</td></tr>`;
            }
            html += '</table>';
            document.getElementById('baseSchedule').innerHTML = html;
        }

        document.getElementById('userSelect').onchange = function() {
            document.getElementById('currentUserDisplay').innerText = `ç›®å‰æ“ä½œï¼š${this.value}`;
            loadStats();
        };

        async function handleClockIn() {
            const user = document.getElementById('userSelect').value;
            if (!user) return alert("è«‹é¸èº«åˆ†");
            startTime = new Date();
            document.getElementById('shiftStatus').innerText = `æ‰“å¡æˆåŠŸ: ${startTime.toLocaleTimeString()}`;
        }

        async function handleClockOut() {
            const user = document.getElementById('userSelect').value;
            if (!startTime) return alert("æœªæ‰“å¡");
            const duration = (new Date() - startTime) / (1000 * 60 * 60);
            
            await supabase.from('work_logs').insert([{ 
                name: user, duration: duration, note: 'å¯¦æ™‚æ‰“å¡' 
            }]);
            alert(`ä¸‹ç­æˆåŠŸï¼å¢åŠ  ${duration.toFixed(2)} å°æ™‚`);
            startTime = null;
            loadStats();
        }

        async function handleManualLog() {
            const realWorker = document.getElementById('userSelect').value;
            const original = document.getElementById('originalOwner').value;
            const hours = parseFloat(document.getElementById('manualHours').value);
            if(!realWorker || !hours) return alert("è³‡æ–™ä¸å…¨");

            await supabase.from('work_logs').insert([{ 
                name: realWorker, 
                duration: hours, 
                original_shift_owner: original,
                is_extra_support: true,
                note: `å¹« ${original} ä»£ç­`
            }]);
            alert("ä»£ç­å·²è¨˜éŒ„");
            loadStats();
        }

        async function loadStats() {
            const { data } = await supabase.from('work_logs').select('name, duration');
            const summary = { Ora: 0, Eva: 0, James: 0 };
            data?.forEach(d => summary[d.name] += d.duration);

            const sorted = Object.entries(summary).sort((a,b) => b[1] - a[1]);
            const maxUser = sorted[0][0];

            let html = "";
            for (let [name, hours] of Object.entries(summary)) {
                let warning = (name === maxUser && hours > 0) ? '<span class="high-workload">âš ï¸ å»ºè­°ä¸‹æ¬¡ä¼‘æ¯</span>' : '';
                html += `<div class="flex-row" style="margin:10px 0;">
                            <span><b>${name}</b>: ${hours.toFixed(1)} å°æ™‚</span>
                            ${warning}
                         </div>`;
            }
            document.getElementById('statsArea').innerHTML = html;
        }

        renderBaseSchedule();
        loadStats();
    </script>
</body>
</html>
