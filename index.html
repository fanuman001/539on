<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julia å½©åˆ¸è¡Œç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { color: #d32f2f; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
        th { background: #d32f2f; color: white; }
        .original { text-decoration: line-through; color: #bbb; font-size: 0.85em; }
        .current { color: #0288d1; font-weight: bold; display: block; }
        .error-box { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; border: 1px solid #ef9a9a; margin-top: 20px; white-space: pre-wrap; }
        .loading-text { text-align: center; color: #666; font-style: italic; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ§§ Julia å½©åˆ¸è¡Œå¯¦æ™‚ç­è¡¨</h2>
        <div id="scheduleArea">
            <p class="loading-text">âŒ› æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº«ï¼Œè«‹ç¨å€™...</p>
        </div>
    </div>

    <script>
        // 1. è«‹åœ¨æ­¤è™•å¡«å…¥ä½ çš„çœŸå¯¦è³‡è¨Š
        const SUPABASE_URL = 'ä½ çš„_URL'; 
        const SUPABASE_KEY = 'ä½ çš„_KEY';

        async function startApp() {
            const area = document.getElementById('scheduleArea');

            // å®‰å…¨æª¢æŸ¥ï¼šæ˜¯å¦å¿˜è¨˜å¡« Key
            if (SUPABASE_URL.includes('ä½ çš„_URL')) {
                area.innerHTML = '<div class="error-box">âŒ åµæ¸¬åˆ°æœªå¡«å¯« Supabase URLã€‚è«‹ä¿®æ”¹ç¨‹å¼ç¢¼ä¸­çš„ URL èˆ‡ Keyã€‚</div>';
                return;
            }

            try {
                const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                // 2. æŠ“å–é è¨­ç­è¡¨ (base_schedule)
                const { data: base, error: baseError } = await supabase
                    .from('base_schedule')
                    .select('*')
                    .order('work_date', { ascending: true });

                if (baseError) throw new Error(`è®€å–é è¨­ç­è¡¨å¤±æ•—: ${baseError.message}`);

                // 3. æŠ“å–æ›ç­ç´€éŒ„ (swap_logs)
                const { data: swaps, error: swapError } = await supabase
                    .from('swap_logs')
                    .select('*');

                if (swapError) console.warn("æ›ç­ç´€éŒ„æŠ“å–å¤±æ•—ï¼Œå°‡é¡¯ç¤ºåŸå§‹ç­è¡¨");

                if (!base || base.length === 0) {
                    area.innerHTML = '<div class="error-box">âš ï¸ è³‡æ–™åº«å…§ç„¡è³‡æ–™ï¼<br>è«‹ç¢ºèªæ˜¯å¦å·²åœ¨ SQL Editor åŸ·è¡Œé INSERT æŒ‡ä»¤ã€‚</div>';
                    return;
                }

                // 4. æ¸²æŸ“è¡¨æ ¼
                let html = '<table><thead><tr><th>æ—¥æœŸ</th><th>æ—©ç­ (08-15)</th><th>æ™šç­ (15-22)</th></tr></thead><tbody>';
                
                base.forEach(row => {
                    const date = row.work_date;
                    const daySwaps = swaps ? swaps.filter(s => s.work_date === date) : [];

                    // è™•ç†æ—©ç­é‚è¼¯
                    let mName = row.morning_shift;
                    let mSwap = daySwaps.find(s => s.original_owner === mName);
                    let mFinal = mSwap ? `<span class="original">${mName}</span><span class="current">${mSwap.new_name}</span>` : mName;

                    // è™•ç†æ™šç­é‚è¼¯ (Array)
                    let eList = row.evening_shift.map(name => {
                        let eSwap = daySwaps.find(s => s.original_owner === name);
                        return eSwap ? `<span class="original">${name}</span><span class="current">${eSwap.new_name}</span>` : name;
                    }).join('<br>');

                    html += `<tr>
                        <td>${date.split('-')[1]}/${date.split('-')[2]}</td>
                        <td><b>Julia</b> + ${mFinal}</td>
                        <td>${eList}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                area.innerHTML = html;

            } catch (err) {
                // å°‡éŒ¯èª¤è¨Šæ¯ç›´æ¥é¡¯ç¤ºåœ¨ç¶²é ä¸Šï¼Œæ–¹ä¾¿é™¤éŒ¯
                area.innerHTML = `<div class="error-box">
<strong>ğŸš¨ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤</strong>
1. è«‹æª¢æŸ¥ Supabase URL/Key æ˜¯å¦æ­£ç¢º
2. è«‹ç¢ºèªè³‡æ–™è¡¨ 'base_schedule' æ˜¯å¦å­˜åœ¨
3. è«‹ç¢ºèª RLS æ¬Šé™æ˜¯å¦å·²é—œé–‰ (Disable RLS)

éŒ¯èª¤è©³æƒ…ï¼š
${err.message}
                </div>`;
            }
        }

        // å•Ÿå‹•ç¨‹å¼
        startApp();
    </script>
</body>
</html>
