<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julia å½©åˆ¸è¡Œç®¡ç†ç³»çµ± v3</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --red: #d32f2f; --blue: #0288d1; --green: #2e7d32; }
        body { font-family: sans-serif; background: #f8f9fa; padding: 10px; max-width: 600px; margin: auto; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h3 { border-left: 4px solid var(--red); padding-left: 10px; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; }
        th { background: #f1f3f4; }
        .original { text-decoration: line-through; color: #999; font-size: 0.8em; }
        .current { color: var(--blue); font-weight: bold; display: block; }
        .btn { padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        .stats-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .warn { color: var(--red); font-weight: bold; font-size: 0.8em; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
    </style>
</head>
<body>

    <h3>ğŸ§§ å¯¦æ™‚å·¥æ™‚çµ±è¨ˆ (å¤šè€…ä¼‘æ¯)</h3>
    <div class="card" id="statsArea">è¼‰å…¥ä¸­...</div>

    <h3>ğŸ“… å¯¦æ™‚ç­è¡¨ (2/14-2/22)</h3>
    <div class="card" id="scheduleArea" style="overflow-x: auto;">è¼‰å…¥ç­è¡¨ä¸­...</div>

    <h3>ğŸ”„ æ‰‹å‹•ä¿®æ­£ / æ›ç­ç™»è¨˜</h3>
    <div class="card">
        <label>é¸æ“‡æ—¥æœŸ</label>
        <input type="date" id="opDate" value="2026-02-14">
        
        <label>é‡å°èª°çš„æ“ä½œï¼Ÿ</label>
        <select id="targetName">
            <option value="Ora">Ora (B)</option>
            <option value="Eva">Eva (C)</option>
            <option value="James">James (D)</option>
        </select>

        <div style="display: flex; gap: 10px;">
            <button class="btn btn-blue" onclick="handleSwap()">æ›´æ›æ­¤æ—¥ç­æ¬¡</button>
            <button class="btn btn-green" onclick="handleAdjustHours()">ä¿®æ­£/å¢åŠ æ™‚æ•¸</button>
        </div>
        <input type="number" id="adjHours" placeholder="è¼¸å…¥æ™‚æ•¸ (å¦‚ 1.5 æˆ– -2)" style="margin-top:10px;">
        <p style="font-size: 0.8em; color: #666;">* æ›ç­è«‹é¸æ—¥æœŸèˆ‡äººï¼›ä¿®æ­£æ™‚æ•¸è«‹è¼¸å…¥æ­£è² å€¼ã€‚</p>
    </div>

    <script>
        const SUPABASE_URL = 'ä½ çš„_URL';
        const SUPABASE_KEY = 'ä½ çš„_KEY';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function refreshData() {
            await loadStats();
            await loadSchedule();
        }

        // è¼‰å…¥ç´¯è¨ˆå·¥æ™‚
        async function loadStats() {
            const { data, error } = await supabase.from('work_logs').select('name, duration');
            if (error) return;

            const sum = { Ora: 0, Eva: 0, James: 0 };
            data.forEach(d => sum[d.name] += d.duration);

            const sorted = Object.entries(sum).sort((a,b) => b[1] - a[1]);
            const maxVal = sorted[0][1];

            let html = "";
            for (let [name, hrs] of Object.entries(sum)) {
                let isMax = (hrs === maxVal && hrs > 0);
                html += `<div class="stats-row">
                    <span><b>${name}</b></span>
                    <span>${hrs.toFixed(1)} hrs ${isMax ? '<span class="warn">âš ï¸ éå‹ï¼Œä¸‹æ¬¡å„ªå…ˆä¼‘æ¯</span>' : ''}</span>
                </div>`;
            }
            document.getElementById('statsArea').innerHTML = html;
        }

        // è¼‰å…¥å‹•æ…‹ç­è¡¨
        async function loadSchedule() {
            const { data: base } = await supabase.from('base_schedule').select('*').order('work_date');
            const { data: swaps } = await supabase.from('swap_logs').select('*');
            
            if (!base) {
                document.getElementById('scheduleArea').innerHTML = "è³‡æ–™åº«ç„¡é è¨­ç­è¡¨è³‡æ–™ã€‚";
                return;
            }

            let html = '<table><tr><th>æ—¥æœŸ</th><th>æ—©ç­</th><th>æ™šç­</th></tr>';
            base.forEach(b => {
                let daySwaps = swaps ? swaps.filter(s => s.work_date === b.work_date) : [];
                
                // è™•ç†æ—©ç­åå–®
                let mShift = b.morning_shift;
                let mSwap = daySwaps.find(s => s.original_owner === mShift);
                let mDisplay = mSwap ? `<span class="original">${mShift}</span><span class="current">${mSwap.new_name}</span>` : mShift;

                // è™•ç†æ™šç­åå–®
                let eDisplay = b.evening_shift.map(p => {
                    let eSwap = daySwaps.find(s => s.original_owner === p);
                    return eSwap ? `<span class="original">${p}</span><span class="current">${eSwap.new_name}</span>` : p;
                }).join('<br>');

                html += `<tr><td>${b.work_date.slice(5)}</td><td>Julia+${mDisplay}</td><td>${eDisplay}</td></tr>`;
            });
            html += '</table>';
            document.getElementById('scheduleArea').innerHTML = html;
        }

        // è™•ç†æ›ç­
        async function handleSwap() {
            const date = document.getElementById('opDate').value;
            const original = prompt("è«‹è¼¸å…¥è¢«æ›æ‰çš„äººå (Ora/Eva/James):");
            const newName = document.getElementById('targetName').value;
            if(!original || !newName) return;

            await supabase.from('swap_logs').insert([{ work_date: date, original_owner: original, new_name: newName }]);
            alert("ç­è¡¨å·²æ›´æ–°");
            refreshData();
        }

        // æ‰‹å‹•ä¿®æ­£å·¥æ™‚ (æ ¸å¿ƒæ–°åŠŸèƒ½)
        async function handleAdjustHours() {
            const name = document.getElementById('targetName').value;
            const hrs = parseFloat(document.getElementById('adjHours').value);
            if(isNaN(hrs)) return alert("è«‹è¼¸å…¥æ­£ç¢ºæ•¸å­—");

            const { error } = await supabase.from('work_logs').insert([
                { name: name, duration: hrs, note: 'æ‰‹å‹•ä¿®æ­£å·¥æ™‚' }
            ]);

            if(!error) {
                alert(`${name} çš„å·¥æ™‚å·²ä¿®æ­£ ${hrs} å°æ™‚`);
                document.getElementById('adjHours').value = "";
                refreshData();
            }
        }

        refreshData();
    </script>
</body>
</html>
