<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Julia å½©åˆ¸è¡Œç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f4f4f4; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #eee; }
        .original { text-decoration: line-through; color: #999; }
        .error-msg { color: red; background: #ffdada; padding: 10px; border-radius: 5px; border: 1px solid red; }
    </style>
</head>
<body>

    <h2>ğŸ§§ Julia å½©åˆ¸è¡Œæ’ç­è¡¨</h2>

    <div id="scheduleArea" class="card">è¼‰å…¥ä¸­...</div>

    <div id="debugArea"></div>

    <script>
        // âš ï¸ è«‹å‹™å¿…æª¢æŸ¥é€™è£¡çš„ URL å’Œ Key å…©ç«¯æœ‰æ²’æœ‰å¤šå‡ºç©ºæ ¼
        const SUPABASE_URL = 'ä½ çš„_URL';
        const SUPABASE_KEY = 'ä½ çš„_KEY';

        // æª¢æŸ¥æ˜¯å¦å¡«å¯«äº† URL
        if (SUPABASE_URL === 'ä½ çš„_URL') {
            document.getElementById('scheduleArea').innerHTML = "<p class='error-msg'>éŒ¯èª¤ï¼šä½ é‚„æ²’å¡«å¯« Supabase çš„ URLï¼</p>";
        }

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function loadSchedule() {
            const area = document.getElementById('scheduleArea');
            try {
                // 1. æŠ“å–é è¨­ç­è¡¨
                const { data: base, error: baseError } = await supabase
                    .from('base_schedule')
                    .select('*')
                    .order('work_date');
                
                if (baseError) throw baseError;

                if (!base || base.length === 0) {
                    area.innerHTML = "<p style='color:orange'>è³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œè«‹åŸ·è¡Œä¹‹å‰çš„ SQL å¯«å…¥è³‡æ–™ã€‚</p>";
                    return;
                }

                // 2. æŠ“å–æ›ç­ç´€éŒ„
                const { data: swaps, error: swapError } = await supabase
                    .from('swap_logs')
                    .select('*');

                // 3. ç•«å‡ºè¡¨æ ¼
                let html = '<table><tr><th>æ—¥æœŸ</th><th>æ—©ç­</th><th>æ™šç­</th></tr>';
                base.forEach(b => {
                    let daySwaps = swaps ? swaps.filter(s => s.work_date === b.work_date) : [];
                    
                    // æ—©ç­é‚è¼¯
                    let mShift = b.morning_shift;
                    let mSwap = daySwaps.find(s => s.original_owner === mShift);
                    let mDisplay = mSwap ? `<span class="original">${mShift}</span> â†’ <b style="color:blue">${mSwap.new_name}</b>` : mShift;

                    // æ™šç­é‚è¼¯
                    let eDisplay = b.evening_shift.map(p => {
                        let eSwap = daySwaps.find(s => s.original_owner === p);
                        return eSwap ? `<span class="original">${p}</span> â†’ <b style="color:blue">${eSwap.new_name}</b>` : p;
                    }).join('<br>');

                    html += `<tr><td>${b.work_date.slice(5)}</td><td>Julia+${mDisplay}</td><td>${eDisplay}</td></tr>`;
                });
                html += '</table>';
                area.innerHTML = html;

            } catch (err) {
                console.error(err);
                area.innerHTML = `<div class="error-msg">
                    <strong>è®€å–å¤±æ•—ï¼š</strong><br>
                    ${err.message}<br><br>
                    <small>è«‹æª¢æŸ¥ Supabase çš„ RLS æ¬Šé™æ˜¯å¦å·²é—œé–‰ã€‚</small>
                </div>`;
            }
        }

        loadSchedule();
    </script>
</body>
</html>
